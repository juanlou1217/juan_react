

### React项目结构

主要分为四个模块

1. `react` ： 面向开发者的 API (`createElement`, `useState`, `Component`)
2. `react-reconciler`（协调器的实现）:  计算更新差异（调度算法） ,Fiber 架构、Diff、更新队列

3. `shared`（公用辅助方法）: 跨模块共享工具与常量 , 类型定义、工具函数

4. 各种宿主环境的包 : 平台相关渲染实现 ：
   - `react-dom` (Web)
     - `react-native` (Native) 
     - `react-art` (Canvas/SVG)
     - `react-test-renderer` (测试)



```Mermaid
graph LR
  A[react] -->|触发更新| B(react-reconciler)
  B -->|调度任务| C(scheduler)
  C -->|执行协调| B
  B -->|输出变更| D[宿主环境包]
```





### jsx转换

JSX 转换过程分为**编译时**和**运行时**两个阶段

#### 编译时

JSX → JavaScript 的静态转换

由 **Babel** 完成，分为三个阶段：

##### **1. 词法分析（Lexical Analysis）**

JSX 代码被拆分为 **Token 流**（标签、属性、文本等）。

```jsx
<div className="header">Hello</div>
→ Tokens: [<div>, className="header", "Hello", </div>]
```

##### **2. 语法分析（Syntax Analysis）**

Token 流组装为 **抽象语法树（AST）**，处理嵌套结构与动态表达式：

```json
{
  "type": "JSXElement",
  "openingElement": { 
    "name": "div", 
    "attributes": [{ "name": "className", "value": "header" }]
  },
  "children": [{ "type": "JSXText", "value": "Hello" }]
}
```

##### **3. 代码生成（Code Generation）**

AST 转换为 JavaScript 函数调用，并处理语法规则（如 `class` → `className`）：

- React 17 前（传统运行时）：

  ```js
  React.createElement("div", { className: "header" }, "Hello");
  ```

- React 17+（自动运行时）：

  ```js
  import { jsx as _jsx } from 'react/jsx-runtime';
  _jsx("div", { className: "header", children: "Hello" });
  ```

  优势：自动导入 jsx-runtime，无需手动引入 React，支持 Tree-shaking

  

  

#### **运行时：**

**JavaScript → 虚拟 DOM 的动态执行**

##### **1. 创建虚拟 DOM（React Element）**

`React.createElement` 或 `_jsx` 函数执行后返回**虚拟 DOM 对象**，轻量化的 UI 描述

```JS
{
  $$typeof: Symbol.for('react.element'),
  type: 'input', // 类型
  props:  { className: "header", children: element },  // 组件属性 : className，id,children,点击事件，
  key: user.id,		// 唯一 ID 作为 key
  ref: inputRef,  // useRef 响应对象
}
```





##### **2. 构建虚拟 DOM 树与 Diff 算法**

组件渲染时，所有虚拟 DOM 节点构成树形结构。

状态更新后，React 通过 **Diff 算法**对比新旧虚拟 DOM 树，计算出最小变更。



##### **3. 事件与状态管理**

运行时还处理事件绑定（如 `onClick`）、组件状态更新（`setState`）等动态逻辑













### **实现 React 的运行时**

#### 实现`jsx`方法

**JSX 语法 → jsx() 函数 → reactElement() 函数 → React Element 对象**

```
JSX 语法 
    ↓ (Babel 编译时)
jsx() 函数调用
    ↓ (运行时)
reactElement() 工厂函数  
    ↓
React Element 对象
```



React Element 对象数据结构

```js
// 属性包括
$$typeof: REACT_ELEMENT_TYPE, // 标识这是一个 React 元素对象
key, // 元素 key
type, // 元素类型
ref, // 元素引用
props, // 元素属性
```



reactElement() 函数进行统一的工厂对象创建输出

 jsx() 函数将识别Babel的格式

​	**特殊属性提取** ： 从 config 中提取 key 和 ref，剩下的都放到 props 对象

​	**安全属性复制** ： 并判断其他属性是否为自身属性，防止恶意的继承属性

​	**子元素标准化** ： 最后对子组件进行判断,优化扁平化



#### 打包实现

新建script/rollup/react.config.js



















