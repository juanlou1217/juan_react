name: Commit Summary

on:
  push:
    branches: [master]
    paths-ignore:
      - 'notes-react/commit_summary.md' 

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GPT Commit Summarizer
        uses: KanHarI/gpt-commit-summarizer@master
        with:
          openai-api-key: ${{ secrets.DEEPSEEK_API_KEY }}
          openai-base-url: 'https://api.deepseek.com'
          mode: "commit"
          output-file: "notes-react/commit_notes.md"
          max-commits: 1  
          exclude-merge: true 
          
          custom-prompt: |
            æˆ‘æ­£åœ¨æ‰‹å†™ React æºç æ¥æ·±å…¥å­¦ä¹  React çš„å†…éƒ¨å®ç°åŸç†ã€‚è¯·åˆ†æè¿™æ¬¡æäº¤ï¼Œç”Ÿæˆæœ‰åŠ©äºç†è§£ React æºç çš„å­¦ä¹ ç¬”è®°ï¼š
            
            ## ğŸ”§ æŠ€æœ¯å®ç°
            - å…·ä½“å®ç°äº†React æºç ä¸­ä»€ä¹ˆåŠŸèƒ½æˆ–ç‰¹æ€§
            - æ¶‰åŠäº†å“ªäº›é‡è¦çš„ React æ¦‚å¿µ 
            
            ## ğŸ’¡ è®¾è®¡æ€è·¯  
            - ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§å®ç°æ–¹å¼
            - æœ‰å®ç°ä»€ä¹ˆä¼˜åŒ–
            
            ## ğŸ“š æºç å­¦ä¹ æ”¶è·
            - é€šè¿‡æ‰‹å†™è¿™éƒ¨åˆ†ä»£ç ï¼Œå¯¹ React å†…éƒ¨æœºåˆ¶æœ‰äº†ä»€ä¹ˆæ–°çš„ç†è§£ï¼Ÿ
            - è¿™ä¸ªå®ç°å¸®åŠ©ç†è§£äº† React çš„å“ªäº›å·¥ä½œåŸç†ï¼Ÿ
            - å‘ç°äº†å“ªäº›ä¹‹å‰ä¸çŸ¥é“çš„ React å†…éƒ¨ç»†èŠ‚ï¼Ÿ
            - è¿™ä¸ªçŸ¥è¯†ç‚¹å¦‚ä½•è¿æ¥åˆ° React çš„æ•´ä½“æ¶æ„ä¸­ï¼Ÿ
  
            
            è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œé‡ç‚¹çªå‡ºå¯¹ React æºç ç†è§£çš„å¸®åŠ©ï¼Œå†…å®¹è¦æ·±å…¥ä¸”å®ç”¨ã€‚

      - name: Format and Commit Notes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–°çš„æ€»ç»“
          if [[ -f "notes-react/commit_notes.md" ]]; then
            
            # è·å–æäº¤ä¿¡æ¯
            COMMIT_HASH=$(git rev-parse HEAD | cut -c1-8)
            COMMIT_MSG=$(git log -1 --pretty=%s)
            COMMIT_DATE=$(date +"%Y-%m-%d %H:%M")
            COMMIT_AUTHOR=$(git log -1 --pretty=%an)
            
            # åˆ›å»ºæ ¼å¼åŒ–çš„ç¬”è®°æ¡ç›®
            cat > temp_note.md << EOF
          
          ============================================================
          ğŸ“… ${COMMIT_DATE} - æäº¤ ${COMMIT_HASH}
          ============================================================
          
          # ğŸ“ ${COMMIT_MSG}
          
          > **æäº¤**: \`${COMMIT_HASH}\` | **æ—¶é—´**: ${COMMIT_DATE} | **ä½œè€…**: ${COMMIT_AUTHOR}
          
          $(cat notes-react/commit_notes.md)
          
          ------------------------------------------------------------
          
          EOF
            
            # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºæ–‡ä»¶ï¼Œæ·»åŠ ä¸“é—¨çš„å¤´éƒ¨
            if [[ ! -f "notes-react/commit_summary.md" ]]; then
              cat > notes-react/commit_summary.md << EOF
          # ğŸ¤– React æºç å­¦ä¹ ç¬”è®°
          
          > æ‰‹å†™ React æºç çš„å­¦ä¹ è®°å½•ï¼Œä¸“æ³¨äºç†è§£ React å†…éƒ¨å®ç°åŸç†
          > 
          > **å­¦ä¹ ç›®æ ‡**: æ·±å…¥ç†è§£ React çš„æ ¸å¿ƒæœºåˆ¶ã€è®¾è®¡æ€è·¯å’Œæ¶æ„åŸç†
          
          EOF
            fi
            
            # å°†æ–°ç¬”è®°è¿½åŠ åˆ°æ€»ç»“æ–‡ä»¶å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            cat temp_note.md notes-react/commit_summary.md > temp_combined.md
            mv temp_combined.md notes-react/commit_summary.md
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f temp_note.md notes-react/commit_notes.md
            
            # æäº¤æ›´æ–°
            git add notes-react/commit_summary.md
            
            if ! git diff --staged --quiet; then
              git commit -m "ğŸ“ Reactæºç å­¦ä¹ : ${COMMIT_MSG} (${COMMIT_HASH}) [skip ci]"
              git push
              echo "âœ… Commit summary updated and pushed"
            else
              echo "â„¹ï¸  No changes to commit"
            fi
          else
            echo "âŒ commit_notes.md not found"
          fi