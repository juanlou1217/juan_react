name: Commit Summary

on:
  push:
    branches: [master]
    paths-ignore:
      - 'notes-react/commit_summary.md'
      - 'notes-react/ai-notes/**'

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install openai dayjs

      - name: Create AI commit analysis script
        run: |
          cat > analyze-commit.js << 'EOF'
          import fs from 'fs';
          import { execSync } from 'child_process';
          import dayjs from 'dayjs';
          import OpenAI from 'openai';

          const openai = new OpenAI({
            baseURL: 'https://api.deepseek.com',
            apiKey: process.env.DEEPSEEK_API_KEY
          });

          async function analyzeCommit() {
            try {
              // è·å–æœ€æ–°æäº¤çš„ä¿¡æ¯
              const commitHash = execSync('git rev-parse HEAD', { encoding: 'utf-8' }).trim();
              const commitMsg = execSync('git log -1 --pretty=%s', { encoding: 'utf-8' }).trim();
              const commitAuthor = execSync('git log -1 --pretty=%an', { encoding: 'utf-8' }).trim();
              const commitDate = dayjs().format('YYYY-MM-DD HH:mm:ss');
              
              // è·å–æäº¤çš„æ–‡ä»¶å˜æ›´
              const changedFiles = execSync('git diff-tree --no-commit-id --name-only -r HEAD', { encoding: 'utf-8' })
                .trim().split('\n').filter(f => f);
              
              // è·å–æäº¤çš„å·®å¼‚ï¼ˆé™åˆ¶é•¿åº¦ï¼‰
              const diff = execSync('git show HEAD --format="" --no-color', { encoding: 'utf-8' }).substring(0, 8000);
              
              // æ„å»º AI åˆ†ææç¤º
              const prompt = `
          æˆ‘æ­£åœ¨æ‰‹å†™ React æºç æ¥æ·±å…¥å­¦ä¹  React çš„å†…éƒ¨å®ç°åŸç†ã€‚è¯·åˆ†æè¿™æ¬¡æäº¤ï¼Œç”Ÿæˆæœ‰åŠ©äºç†è§£ React æºç çš„å­¦ä¹ ç¬”è®°ï¼š

          ## ğŸ“ æäº¤ä¿¡æ¯
          **æäº¤**: ${commitHash.substring(0, 8)}
          **æ¶ˆæ¯**: ${commitMsg}
          **ä½œè€…**: ${commitAuthor}
          **æ—¶é—´**: ${commitDate}
          **å˜æ›´æ–‡ä»¶**: ${changedFiles.join(', ')}

          ## ğŸ’» ä»£ç å˜æ›´
          \`\`\`diff
          ${diff}
          \`\`\`

          è¯·ç”Ÿæˆè¯¦ç»†çš„å­¦ä¹ æ€»ç»“ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

          ## ğŸ”§ æŠ€æœ¯å®ç°
          - å…·ä½“å®ç°äº†React æºç ä¸­ä»€ä¹ˆåŠŸèƒ½æˆ–ç‰¹æ€§
          - æ¶‰åŠäº†å“ªäº›é‡è¦çš„ React æ¦‚å¿µ 

          ## ğŸ’¡ è®¾è®¡æ€è·¯  
          - ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§å®ç°æ–¹å¼
          - æœ‰å®ç°ä»€ä¹ˆä¼˜åŒ–

          ## ğŸ“š æºç å­¦ä¹ æ”¶è·
          - é€šè¿‡æ‰‹å†™è¿™éƒ¨åˆ†ä»£ç ï¼Œå¯¹ React å†…éƒ¨æœºåˆ¶æœ‰äº†ä»€ä¹ˆæ–°çš„ç†è§£ï¼Ÿ
          - è¿™ä¸ªå®ç°å¸®åŠ©ç†è§£äº† React çš„å“ªäº›å·¥ä½œåŸç†ï¼Ÿ
          - å‘ç°äº†å“ªäº›ä¹‹å‰ä¸çŸ¥é“çš„ React å†…éƒ¨ç»†èŠ‚ï¼Ÿ
          - è¿™ä¸ªçŸ¥è¯†ç‚¹å¦‚ä½•è¿æ¥åˆ° React çš„æ•´ä½“æ¶æ„ä¸­ï¼Ÿ

          è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œé‡ç‚¹çªå‡ºå¯¹ React æºç ç†è§£çš„å¸®åŠ©ï¼Œå†…å®¹è¦æ·±å…¥ä¸”å®ç”¨ã€‚
          `;

              // è°ƒç”¨ AI ç”Ÿæˆåˆ†æ
              const response = await openai.chat.completions.create({
                model: 'deepseek-chat',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 4000
              });

              const analysis = response.choices[0].message.content.trim();
              
              // åˆ›å»ºæ ¼å¼åŒ–çš„æ€»ç»“
              const summary = `
          ============================================================
          ğŸ“… ${commitDate} - æäº¤ ${commitHash.substring(0, 8)}
          ============================================================

          # ğŸ“ ${commitMsg}

          > **æäº¤**: \`${commitHash.substring(0, 8)}\` | **æ—¶é—´**: ${commitDate} | **ä½œè€…**: ${commitAuthor}

          ${analysis}

          ------------------------------------------------------------

          `;

              // ç¡®ä¿ç›®å½•å­˜åœ¨
              if (!fs.existsSync('notes-react')) {
                fs.mkdirSync('notes-react', { recursive: true });
              }

              // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºæ–‡ä»¶ï¼Œæ·»åŠ å¤´éƒ¨
              if (!fs.existsSync('notes-react/commit_summary.md')) {
                const header = `# ğŸ¤– React æºç å­¦ä¹ ç¬”è®°

          > æ‰‹å†™ React æºç çš„å­¦ä¹ è®°å½•ï¼Œä¸“æ³¨äºç†è§£ React å†…éƒ¨å®ç°åŸç†
          > 
          > **å­¦ä¹ ç›®æ ‡**: æ·±å…¥ç†è§£ React çš„æ ¸å¿ƒæœºåˆ¶ã€è®¾è®¡æ€è·¯å’Œæ¶æ„åŸç†

          `;
                fs.writeFileSync('notes-react/commit_summary.md', header, 'utf-8');
              }

              // å°†æ–°æ€»ç»“æ·»åŠ åˆ°æ–‡ä»¶å¼€å¤´
              const existingContent = fs.readFileSync('notes-react/commit_summary.md', 'utf-8');
              const newContent = existingContent.replace(
                /(# ğŸ¤– React æºç å­¦ä¹ ç¬”è®°[\s\S]*?\n\n)/,
                `$1${summary}`
              );
              
              fs.writeFileSync('notes-react/commit_summary.md', newContent, 'utf-8');
              
              console.log('âœ… Commit analysis completed and saved to notes-react/commit_summary.md');
              
            } catch (error) {
              console.error('âŒ Error analyzing commit:', error.message);
              process.exit(1);
            }
          }

          analyzeCommit();
          EOF

      - name: Run commit analysis
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          node analyze-commit.js

      - name: Commit and Push Summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if [[ -f "notes-react/commit_summary.md" ]]; then
            git add notes-react/commit_summary.md
            
            if ! git diff --staged --quiet; then
              COMMIT_HASH=$(git rev-parse HEAD | cut -c1-8)
              COMMIT_MSG=$(git log -1 --pretty=%s)
              git commit -m "ğŸ“ Reactæºç å­¦ä¹ : ${COMMIT_MSG} (${COMMIT_HASH}) [skip ci]"
              
              # ä½¿ç”¨ GITHUB_TOKEN æ¨é€
              git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
              git push
              echo "âœ… Commit summary updated and pushed"
            else
              echo "â„¹ï¸  No changes to commit"
            fi
          else
            echo "âŒ commit_summary.md not found"
          fi